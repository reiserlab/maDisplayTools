# Protocol Version 1 - Complete Example
# This example demonstrates all features of the protocol specification

version: 1

# ============================================================================
# EXPERIMENT METADATA
# ============================================================================
experiment_info:
  name: "Multi-Plugin Visual Stimulus Experiment"
  date_created: "2024-01-15"
  author: "Research Lab"
  pattern_library: '/Users/lisaferguson/Documents/PC/Programming/Reiser/test_patternsBin_100_2x12'

# ============================================================================
# ARENA CONFIGURATION
# ============================================================================
arena_info:
  num_rows: 2
  num_cols: 12
  generation: "G4.1"

# ============================================================================
# PLUGIN DEFINITIONS
# ============================================================================
plugins:
  # Example of a serial device plugin (not tied to any real device right now)
  - name: "simple serial device"
    type: "serial_device"
    port: "COM4"
    baudrate: 115200
    commands:
      activate: "RED 50\nGREEN 0\nBLUE 0\nON 0,0"
      reset: "RESET"
      off: "OFF"

  # Class Plugin - Camera/video capture system
    # will automatically be initialized and connected and config file loaded 
    # IF config_path, ip, and port are provided. If they are not provided, 
    # user will have to define these commands in the trials below.
  - name: "bias_camera"
    type: "class"
    matlab:
      class: "BiasPlugin"
    config:
      bias_executable: '/path/to/BIAS/executable.exe' 
      config_path: './config/simple_bias_config.json'  # UPDATE THESE BEFORE RUNNING
      ip: "127.0.0.1" # UPDATE THESE BEFORE RUNNING IF NEED BE
      port: 5010 # will connect and load configuration automatically 

  - name: "backlight"
    type: "class"
    matlab:
      class: "LEDControllerPlugin"
    config:
      port: "COM6"

  # Script Plugin - Custom preprocessing
  - name: "preprocessing"
    type: "script"
    script_path: './user_functions/preprocess_data'

  # Script Plugin - Post-trial analysis
  - name: "analysis"
    type: "script"
    script_path: './user_functions/analyze_trial'

# ============================================================================
# EXPERIMENT STRUCTURE
# ============================================================================
experiment_structure:
  repetitions: 3
  randomization:
    enabled: true
    seed: null  # null = random seed; set to integer for reproducibility
    method: "block"  # "block" is only option right now

# ============================================================================
# PRETRIAL - Execute once before any trials
# Used for hardware initialization and setup
# ============================================================================
pretrial:
  include: true
  commands:
    
    # Initialize background lighting
    - type: "plugin"
      plugin_name: "backlight"
      command_name: "activate"
    
    # Wait for systems to stabilize
    - type: "wait"
      duration: 1  # 1 second
    
    # Run preprocessing script
    - type: "plugin"
      plugin_name: "preprocessing"
    
    # Display a test pattern to verify arena
    - type: "controller"
      command_name: "trialParams"
      pattern: 'pat0094_num93_2x12.pat'
      pattern_ID: 94
      duration: 2  # 2 seconds
      mode: 2  # position mode
      frame_index: 1
      frame_rate: 60
      gain: 0
    
    - type: "wait"
      duration: 0.5  # 0.5 second pause

# ============================================================================
# BLOCK - Main experimental conditions
# These are the core trials that will be repeated and/or randomized
# ============================================================================
block:
  conditions:
    # Condition 1: Vertical bars moving right
    - id: "vertical_bars_right"
      commands:
        # Start recording
        - type: "plugin"
          plugin_name: "bias_camera"
          command_name: "startRecording" #startRecording sets video file, starts capture, and starts logging.
          params:
            filename: "vertical_bars_right.avi"
       
        
        # Pulse LED to mark trial start
        - type: "plugin"
          plugin_name: "backlight"
          command_name: "pulse"
        
        # Wait 100ms
        - type: "wait"
          duration: 0.1
        
        # Display pattern
        - type: "controller"
          command_name: "trialParams"
          pattern: 'pat0071_num70_2x12.pat'
          pattern_ID: 71
          duration: 5  # 5 seconds
          mode: 2  # closed-loop mode
          frame_index: 1
          frame_rate: 60
          gain: -90  # degrees per second

        - type: "plugin"
          plugin_name: "bias_camera"
          command_name: "stopRecording"
    
    # Condition 2: Horizontal bars moving up
    - id: "horizontal_bars_up"
      commands:
        - type: "plugin"
          plugin_name: "bias_camera"
          command_name: "startRecording"
          params:
            filename: "horizontal_bars_up.avi"

        
        - type: "plugin"
          plugin_name: "backlight"
          command_name: "pulse"
        
        - type: "wait"
          duration: 0.1
        
        - type: "controller"
          command_name: "trialParams"
          pattern: 'pat0002_num01_2x12.pat'
          pattern_ID: 3
          duration: 5
          mode: 2
          frame_index: 1
          frame_rate: 60
          gain: -90
        
        - type: "plugin"
          plugin_name: "bias_camera"
          command_name: "stopRecording"
    
    # Condition 3: Checkerboard pattern (static)
    - id: "checkerboard_static"
      commands:
        - type: "plugin"
          plugin_name: "bias_camera"
          command_name: "startRecording"
          params:
            filename: "checkerboard.avi"
        
        - type: "plugin"
          plugin_name: "backlight"
          command_name: "pulse"
        
        - type: "wait"
          duration: 0.1
        
        - type: "controller"
          command_name: "trialParams"
          pattern: 'pat0007_num06_2x12.pat'
          pattern_ID: 4
          duration: 3  # 3 seconds
          mode: 2  # position mode (static)
          frame_index: 1
          frame_rate: 60
          gain: 0
        
        - type: "plugin"
          plugin_name: "bias_camera"
          command_name: "stopRecording"
    
    # Condition 4: Expanding grating
    - id: "expanding_grating"
      commands:
        - type: "plugin"
          plugin_name: "bias_camera"
          command_name: "startRecording"
          params:
            filename: "expanding_grating.avi"
        
        - type: "plugin"
          plugin_name: "backlight"
          command_name: "pulse"
        
        - type: "wait"
          duration: 0.1
        
        - type: "controller"
          command_name: "trialParams"
          pattern: 'pat0012_num11_2x12.pat'
          pattern_ID: 12
          duration: 4  # 4 seconds
          mode: 2
          frame_index: 1
          frame_rate: 60
          gain: -45
        
        - type: "plugin"
          plugin_name: "bias_camera"
          command_name: "stopRecording"
    
    # Condition 5: Dark (no stimulus)
    - id: "dark_control"
      commands:
        - type: "plugin"
          plugin_name: "bias_camera"
          command_name: "startRecording"
          params:
            filename: "dark_control.avi"
        
        - type: "plugin"
          plugin_name: "backlight"
          command_name: "pulse"
        
        # Turn off arena
        - type: "plugin"
          plugin_name: "backlight"
          command_name: "off"
        
        # Wait in darkness
        - type: "wait"
          duration: 3  # 3 seconds
        
        # Turn background back on
        - type: "plugin"
          plugin_name: "backlight"
          command_name: "activate"
        
        - type: "plugin"
          plugin_name: "bias_camera"
          command_name: "stopCapture"

# ============================================================================
# INTERTRIAL - Execute between each trial
# Used for baseline periods and resetting hardware state
# ============================================================================
intertrial:
  include: true
  commands:
    # Reset to baseline pattern
    - type: "controller"
      command_name: "trialParams"
      pattern: 'pat0014_num13_2x12.pat'
      pattern_ID: 6
      duration: 2  # 2 second inter-trial interval
      mode: 2
      frame_index: 1
      frame_rate: 60
      gain: 0
    
    # Run analysis script on previous trial
    - type: "plugin"
      plugin_name: "analysis"
    
    # Brief pause
    - type: "wait"
      duration: 0.5  # 0.5 second

# ============================================================================
# POSTTRIAL - Execute once after all trials complete
# Used for cleanup, data saving, and shutdown
# ============================================================================
posttrial:
  include: true
  commands:
    # Stop all recording systems
    - type: "plugin"
      plugin_name: "bias_camera"
      command_name: "disconnect"
    
    # Turn off hardware
    - type: "plugin"
      plugin_name: "backlight"
      command_name: "off"
    
    # Display completion message pattern
    - type: "controller"
      command_name: "trialParams"
      pattern: 'pat0031_num30_2x12.pat'
      pattern_ID: 7
      duration: 2
      mode: 2
      frame_index: 1
      frame_rate: 60
      gain: 0
    
    # Final wait before shutdown
    - type: "wait"
      duration: 1  # 1 second

# ============================================================================
# CONTROLLER COMMANDS REFERENCE
# ============================================================================
# Available controller commands and their parameters:
#
# allOn - Turn all arena panels on
#   Parameters: (none)
#
# allOff - Turn all arena panels off
#   Parameters: (none)
# 
# stopDisplay - stop displaying pattern
#   Parameters: (none)
#
# setPositionX - set the starting frame when displaying a pattern (default 1)
#   Parameters: posX: integer between 1 and number of frames in pattern
#
# setColorDepth - change the arena's accepted grayscale value 
#   Parameters: gs_val: 2 or 16
#
# trialParams - start displaying a trial on the G4.1 system
#   Parameters: mode: integer 2-4 
#               patID: integer from 1 - number of patterns available  
#               posX: integer, starting frame number  
#               dur: duration of the experiment in seconds (converted to deciseconds at runtime) 
#               frameRate: Frames per second, mode 2 only
#               gain: integer, mode 4 only
#
#
# Note: streamFrame is also available but should not be used via yaml. 
#
#
# ============================================================================
