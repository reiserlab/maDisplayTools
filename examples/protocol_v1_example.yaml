# Protocol Version 1 - Complete Example
# This example demonstrates all features of the protocol specification

version: 1

# ============================================================================
# EXPERIMENT METADATA
# ============================================================================
experiment_info:
  name: "Multi-Plugin Visual Stimulus Experiment"
  date_created: "2024-01-15"
  author: "Research Lab"
  pattern_library:

# ============================================================================
# ARENA CONFIGURATION
# ============================================================================
arena_info:
  num_rows: 4
  num_cols: 12
  generation: "G4.1"

# ============================================================================
# PLUGIN DEFINITIONS
# ============================================================================
plugins:
  # Serial Device Plugin - Background illumination control
  - name: "background_light"
    type: "serial_device"
    port: "/dev/ttyUSB0"
    port_windows: "COM4"
    port_posix: "/dev/ttyUSB0"
    baudrate: 115200
    commands:
      activate: "RED 50\nGREEN 0\nBLUE 0\nON 0,0"
      reset: "RESET"
      off: "OFF"

  # Serial Device Plugin - LED controller
  - name: "led_controller"
    type: "serial_device"
    port: "/dev/ttyUSB1"
    port_windows: "COM5"
    port_posix: "/dev/ttyUSB1"
    baudrate: 9600
    commands:
      on: "LED ON"
      off: "LED OFF"
      pulse: "PULSE 100"

  # Class Plugin - Camera/video capture system
  - name: "simple_bias"
    type: "class"
    matlab:
      class: "maDisplayTools.plugins.SimpleBias"
    python:
      module: "pyDisplayTools.plugins.SimpleBias"
      class: "SimpleBias"
    config:
      ip: "127.0.0.1"
      port: 5020
      config_path: './config/simple_bias_config.json'

  # Class Plugin - Data acquisition system
  - name: "daq_system"
    type: "class"
    matlab:
      class: "maDisplayTools.plugins.DAQController"
    python:
      module: "pyDisplayTools.plugins.DAQController"
      class: "DAQController"
    config:
      sample_rate: 1000
      channels: ["ai0", "ai1", "ai2"]
      device: "Dev1"

  # Script Plugin - Custom preprocessing
  - name: "preprocessing"
    type: "script"
    script_path: './user_functions/preprocess_data'

  # Script Plugin - Post-trial analysis
  - name: "analysis"
    type: "script"
    script_path: './user_functions/analyze_trial'

# ============================================================================
# EXPERIMENT STRUCTURE
# ============================================================================
experiment_structure:
  repetitions: 3
  randomization:
    enabled: true
    seed: null  # null = random seed; set to integer for reproducibility
    method: "block"  # "block" is only option right now

# ============================================================================
# PRETRIAL - Execute once before any trials
# Used for hardware initialization and setup
# ============================================================================
pretrial:
  include: true
  commands:
    # Initialize camera system
    - type: "plugin"
      plugin_name: "simple_bias"
      command_name: "connect"
    
    - type: "plugin"
      plugin_name: "simple_bias"
      command_name: "initialize"
      params:
        resolution: [1920, 1080]
        fps: 30
    
    # Initialize DAQ system
    - type: "plugin"
      plugin_name: "daq_system"
      command_name: "connect"
    
    - type: "plugin"
      plugin_name: "daq_system"
      command_name: "configure"
      params:
        buffer_size: 10000
    
    # Initialize background lighting
    - type: "plugin"
      plugin_name: "background_light"
      command_name: "activate"
    
    # Wait for systems to stabilize
    - type: "wait"
      duration: 1000  # 1 second
    
    # Run preprocessing script
    - type: "plugin"
      plugin_name: "preprocessing"
    
    # Display a test pattern to verify arena
    - type: "controller"
      command_name: "startG41Trial"
      pattern: './patterns/pat0001_test_grid.pat'
      pattern_ID: 1
      duration: 2000  # 2 seconds
      mode: 2  # position mode
      frame_index: 1
      frame_rate: 60
      gain: 0
    
    - type: "wait"
      duration: 500  # 0.5 second pause

# ============================================================================
# BLOCK - Main experimental conditions
# These are the core trials that will be repeated and/or randomized
# ============================================================================
block:
  conditions:
    # Condition 1: Vertical bars moving right
    - id: "vertical_bars_right"
      commands:
        # Start recording
        - type: "plugin"
          plugin_name: "simple_bias"
          command_name: "startCapture"
        
        - type: "plugin"
          plugin_name: "simple_bias"
          command_name: "setVideoFile"
          params:
            filename: "vertical_bars_right.avi"
        
        # Start DAQ
        - type: "plugin"
          plugin_name: "daq_system"
          command_name: "startAcquisition"
        
        # Pulse LED to mark trial start
        - type: "plugin"
          plugin_name: "led_controller"
          command_name: "pulse"
        
        # Wait 50ms
        - type: "wait"
          duration: 50
        
        # Display pattern
        - type: "controller"
          command_name: "startG41Trial"
          pattern: './patterns/pat0002_vertical_bars.pat'
          pattern_ID: 2
          duration: 5000  # 5 seconds
          mode: 2  # closed-loop mode
          frame_index: 1
          frame_rate: 60
          gain: -90  # degrees per second
        
        # Stop recording
        - type: "plugin"
          plugin_name: "daq_system"
          command_name: "stopAcquisition"
        
        - type: "plugin"
          plugin_name: "simple_bias"
          command_name: "stopCapture"
    
    # Condition 2: Horizontal bars moving up
    - id: "horizontal_bars_up"
      commands:
        - type: "plugin"
          plugin_name: "simple_bias"
          command_name: "startCapture"
        
        - type: "plugin"
          plugin_name: "simple_bias"
          command_name: "setVideoFile"
          params:
            filename: "horizontal_bars_up.avi"
        
        - type: "plugin"
          plugin_name: "daq_system"
          command_name: "startAcquisition"
        
        - type: "plugin"
          plugin_name: "led_controller"
          command_name: "pulse"
        
        - type: "wait"
          duration: 50
        
        - type: "controller"
          command_name: "startG41Trial"
          pattern: './patterns/pat0003_horizontal_bars.pat'
          pattern_ID: 3
          duration: 5000
          mode: 2
          frame_index: 1
          frame_rate: 60
          gain: -90
        
        - type: "plugin"
          plugin_name: "daq_system"
          command_name: "stopAcquisition"
        
        - type: "plugin"
          plugin_name: "simple_bias"
          command_name: "stopCapture"
    
    # Condition 3: Checkerboard pattern (static)
    - id: "checkerboard_static"
      commands:
        - type: "plugin"
          plugin_name: "simple_bias"
          command_name: "startCapture"
        
        - type: "plugin"
          plugin_name: "simple_bias"
          command_name: "setVideoFile"
          params:
            filename: "checkerboard.avi"
        
        - type: "plugin"
          plugin_name: "daq_system"
          command_name: "startAcquisition"
        
        - type: "plugin"
          plugin_name: "led_controller"
          command_name: "pulse"
        
        - type: "wait"
          duration: 50
        
        - type: "controller"
          command_name: "startG41Trial"
          pattern: './patterns/pat0004_checkerboard.pat'
          pattern_ID: 4
          duration: 3000  # 3 seconds
          mode: 2  # position mode (static)
          frame_index: 1
          frame_rate: 60
          gain: 0
        
        - type: "plugin"
          plugin_name: "daq_system"
          command_name: "stopAcquisition"
        
        - type: "plugin"
          plugin_name: "simple_bias"
          command_name: "stopCapture"
    
    # Condition 4: Expanding grating
    - id: "expanding_grating"
      commands:
        - type: "plugin"
          plugin_name: "simple_bias"
          command_name: "startCapture"
        
        - type: "plugin"
          plugin_name: "simple_bias"
          command_name: "setVideoFile"
          params:
            filename: "expanding_grating.avi"
        
        - type: "plugin"
          plugin_name: "daq_system"
          command_name: "startAcquisition"
        
        - type: "plugin"
          plugin_name: "led_controller"
          command_name: "pulse"
        
        - type: "wait"
          duration: 50
        
        - type: "controller"
          command_name: "startG41Trial"
          pattern: './patterns/pat0005_expanding_grating.pat'
          pattern_ID: 5
          duration: 4000  # 4 seconds
          mode: 2
          frame_index: 1
          frame_rate: 60
          gain: -45

        - type: "plugin"
          plugin_name: "daq_system"
          command_name: "stopAcquisition"
        
        - type: "plugin"
          plugin_name: "simple_bias"
          command_name: "stopCapture"
    
    # Condition 5: Dark (no stimulus)
    - id: "dark_control"
      commands:
        - type: "plugin"
          plugin_name: "simple_bias"
          command_name: "startCapture"
        
        - type: "plugin"
          plugin_name: "simple_bias"
          command_name: "setVideoFile"
          params:
            filename: "dark_control.avi"
        
        - type: "plugin"
          plugin_name: "daq_system"
          command_name: "startAcquisition"
        
        - type: "plugin"
          plugin_name: "led_controller"
          command_name: "pulse"
        
        # Turn off arena
        - type: "plugin"
          plugin_name: "background_light"
          command_name: "off"
        
        # Wait in darkness
        - type: "wait"
          duration: 3000  # 3 seconds
        
        # Turn background back on
        - type: "plugin"
          plugin_name: "background_light"
          command_name: "activate"
        
        - type: "plugin"
          plugin_name: "daq_system"
          command_name: "stopAcquisition"
        
        - type: "plugin"
          plugin_name: "simple_bias"
          command_name: "stopCapture"

# ============================================================================
# INTERTRIAL - Execute between each trial
# Used for baseline periods and resetting hardware state
# ============================================================================
intertrial:
  include: true
  commands:
    # Reset to baseline pattern
    - type: "controller"
      command_name: "startG41Trial"
      pattern: './patterns/pat0006_uniform_gray.pat'
      pattern_ID: 6
      duration: 2000  # 2 second inter-trial interval
      mode: 2
      frame_index: 1
      frame_rate: 60
      gain: 0
    
    # Run analysis script on previous trial
    - type: "plugin"
      plugin_name: "analysis"
    
    # Brief pause
    - type: "wait"
      duration: 500  # 0.5 second

# ============================================================================
# POSTTRIAL - Execute once after all trials complete
# Used for cleanup, data saving, and shutdown
# ============================================================================
posttrial:
  include: true
  commands:
    # Stop all recording systems
    - type: "plugin"
      plugin_name: "simple_bias"
      command_name: "disconnect"
    
    - type: "plugin"
      plugin_name: "daq_system"
      command_name: "disconnect"
    
    # Turn off hardware
    - type: "plugin"
      plugin_name: "background_light"
      command_name: "off"
    
    - type: "plugin"
      plugin_name: "led_controller"
      command_name: "off"
    
    # Display completion message pattern
    - type: "controller"
      command_name: "startG41Trial"
      pattern: './patterns/pat0007_complete.pat'
      pattern_ID: 7
      duration: 2000
      mode: 2
      frame_index: 1
      frame_rate: 60
      gain: 0
    
    # Final wait before shutdown
    - type: "wait"
      duration: 1000  # 1 second

# ============================================================================
# CONTROLLER COMMANDS REFERENCE
# ============================================================================
# Available controller commands and their parameters:
#
# allOn - Turn all arena panels on
#   Parameters: (none)
#
# allOff - Turn all arena panels off
#   Parameters: (none)
# 
# stopDisplay - stop displaying pattern
#   Parameters: (none)
#
# setPositionX - set the starting frame when displaying a pattern (default 1)
#   Parameters: posX: integer between 1 and number of frames in pattern
#
# setColorDepth - change the arena's accepted grayscale value 
#   Parameters: gs_val: 2 or 16
#
# startG41Trial - start displaying a trial on the G4.1 system
#   Parameters: mode: integer 2-4 
#               patID: integer from 1 - number of patterns available  
#               posX: integer, starting frame number  
#               dur: duration of the experiment in seconds (converted to deciseconds at runtime) 
#               frameRate: Frames per second, mode 2 only
#               gain: integer, mode 4 only
#
#
# Note: streamFrame is also available but should not be used via yaml. 
#
#
# ============================================================================
