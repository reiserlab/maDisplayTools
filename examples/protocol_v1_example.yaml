# Protocol Version 1 - Complete Example
# This example demonstrates all features of the protocol specification

version: 1

# ============================================================================
# EXPERIMENT METADATA
# ============================================================================
experiment_info:
  name: "Multi-Plugin Visual Stimulus Experiment"
  date_created: "2024-01-15"
  author: "Research Lab"

# ============================================================================
# ARENA CONFIGURATION
# ============================================================================
arena_info:
  num_rows: 4
  num_cols: 12
  generation: "G4"

# ============================================================================
# PLUGIN DEFINITIONS
# ============================================================================
plugins:
  # Serial Device Plugin - Background illumination control
  - id: "background_light"
    type: "serial_device"
    port_windows: "COM4"
    port_posix: "/dev/ttyUSB0"
    baudrate: 115200
    commands:
      activate: "RED 50\nGREEN 0\nBLUE 0\nON 0,0"
      reset: "RESET"
      off: "OFF"

  # Serial Device Plugin - LED controller
  - id: "led_controller"
    type: "serial_device"
    port_windows: "COM5"
    port_posix: "/dev/ttyUSB1"
    baudrate: 9600
    commands:
      on: "LED ON"
      off: "LED OFF"
      pulse: "PULSE 100"

  # Class Plugin - Camera/video capture system
  - id: "simple_bias"
    type: "class"
    matlab:
      class: "maDisplayTools.plugins.SimpleBias"
    python:
      module: "pyDisplayTools.plugins.SimpleBias"
      class: "SimpleBias"
    config:
      ip: "127.0.0.1"
      port: 5020
      config_path: "./config/simple_bias_config.json"

  # Class Plugin - Data acquisition system
  - id: "daq_system"
    type: "class"
    matlab:
      class: "maDisplayTools.plugins.DAQController"
    python:
      module: "pyDisplayTools.plugins.DAQController"
      class: "DAQController"
    config:
      sample_rate: 1000
      channels: ["ai0", "ai1", "ai2"]
      device: "Dev1"

  # Script Plugin - Custom preprocessing
  - id: "preprocessing"
    type: "script"
    script: "./user_functions/preprocess_data"

  # Script Plugin - Post-trial analysis
  - id: "analysis"
    type: "script"
    script: "./user_functions/analyze_trial"

# ============================================================================
# EXPERIMENT STRUCTURE
# ============================================================================
experiment_structure:
  repetitions: 3
  randomization:
    enabled: true
    seed: null  # null = random seed; set to integer for reproducibility
    method: "block"  # "block" or "trial"

# ============================================================================
# PRETRIAL - Execute once before any trials
# Used for hardware initialization and setup
# ============================================================================
pretrial:
  include: true
  commands:
    # Initialize camera system
    - plugin: "simple_bias"
      method: "connect"
    
    - plugin: "simple_bias"
      method: "initialize"
      params:
        resolution: [1920, 1080]
        fps: 30
    
    # Initialize DAQ system
    - plugin: "daq_system"
      method: "connect"
    
    - plugin: "daq_system"
      method: "configure"
      params:
        buffer_size: 10000
    
    # Initialize background lighting
    - plugin: "background_light"
      command: "activate"
    
    # Wait for systems to stabilize
    - type: "wait"
      duration: 1000  # 1 second
    
    # Run preprocessing script
    - plugin: "preprocessing"
    
    # Display a test pattern to verify arena
    - type: "streamFrame"
      pattern: "./patterns/pat0001_test_grid.pat"
      duration: 2000  # 2 seconds
      mode: 0  # position mode
      frame_index: 1
      frame_rate: 60
      gain: 0
      offset: 0
    
    - type: "wait"
      duration: 500  # 0.5 second pause

# ============================================================================
# BLOCK - Main experimental conditions
# These are the core trials that will be repeated and/or randomized
# ============================================================================
block:
  conditions:
    # Condition 1: Vertical bars moving right
    - id: "vertical_bars_right"
      commands:
        # Start recording
        - plugin: "simple_bias"
          method: "startCapture"
        
        - plugin: "simple_bias"
          method: "setVideoFile"
          params:
            filename: "vertical_bars_right.avi"
        
        # Start DAQ
        - plugin: "daq_system"
          method: "startAcquisition"
        
        # Pulse LED to mark trial start
        - plugin: "led_controller"
          command: "pulse"
        
        # Wait 50ms
        - type: "wait"
          duration: 50
        
        # Display pattern
        - type: "streamFrame"
          pattern: "./patterns/pat0002_vertical_bars.pat"
          duration: 5000  # 5 seconds
          mode: 0  # closed-loop mode
          frame_index: 1
          frame_rate: 60
          gain: -90  # degrees per second
          offset: 0
        
        # Stop recording
        - plugin: "daq_system"
          method: "stopAcquisition"
        
        - plugin: "simple_bias"
          method: "stopCapture"
    
    # Condition 2: Horizontal bars moving up
    - id: "horizontal_bars_up"
      commands:
        - plugin: "simple_bias"
          method: "startCapture"
        
        - plugin: "simple_bias"
          method: "setVideoFile"
          params:
            filename: "horizontal_bars_up.avi"
        
        - plugin: "daq_system"
          method: "startAcquisition"
        
        - plugin: "led_controller"
          command: "pulse"
        
        - type: "wait"
          duration: 50
        
        - type: "streamFrame"
          pattern: "./patterns/pat0003_horizontal_bars.pat"
          duration: 5000
          mode: 0
          frame_index: 1
          frame_rate: 60
          gain: -90
          offset: 0
        
        - plugin: "daq_system"
          method: "stopAcquisition"
        
        - plugin: "simple_bias"
          method: "stopCapture"
    
    # Condition 3: Checkerboard pattern (static)
    - id: "checkerboard_static"
      commands:
        - plugin: "simple_bias"
          method: "startCapture"
        
        - plugin: "simple_bias"
          method: "setVideoFile"
          params:
            filename: "checkerboard.avi"
        
        - plugin: "daq_system"
          method: "startAcquisition"
        
        - plugin: "led_controller"
          command: "pulse"
        
        - type: "wait"
          duration: 50
        
        - type: "streamFrame"
          pattern: "./patterns/pat0004_checkerboard.pat"
          duration: 3000  # 3 seconds
          mode: 0  # position mode (static)
          frame_index: 1
          frame_rate: 60
          gain: 0
          offset: 0
        
        - plugin: "daq_system"
          method: "stopAcquisition"
        
        - plugin: "simple_bias"
          method: "stopCapture"
    
    # Condition 4: Expanding grating
    - id: "expanding_grating"
      commands:
        - plugin: "simple_bias"
          method: "startCapture"
        
        - plugin: "simple_bias"
          method: "setVideoFile"
          params:
            filename: "expanding_grating.avi"
        
        - plugin: "daq_system"
          method: "startAcquisition"
        
        - plugin: "led_controller"
          command: "pulse"
        
        - type: "wait"
          duration: 50
        
        - type: "streamFrame"
          pattern: "./patterns/pat0005_expanding_grating.pat"
          duration: 4000  # 4 seconds
          mode: 0
          frame_index: 1
          frame_rate: 60
          gain: -45
          offset: 0
        
        - plugin: "daq_system"
          method: "stopAcquisition"
        
        - plugin: "simple_bias"
          method: "stopCapture"
    
    # Condition 5: Dark (no stimulus)
    - id: "dark_control"
      commands:
        - plugin: "simple_bias"
          method: "startCapture"
        
        - plugin: "simple_bias"
          method: "setVideoFile"
          params:
            filename: "dark_control.avi"
        
        - plugin: "daq_system"
          method: "startAcquisition"
        
        - plugin: "led_controller"
          command: "pulse"
        
        # Turn off arena
        - plugin: "background_light"
          command: "off"
        
        # Wait in darkness
        - type: "wait"
          duration: 3000  # 3 seconds
        
        # Turn background back on
        - plugin: "background_light"
          command: "activate"
        
        - plugin: "daq_system"
          method: "stopAcquisition"
        
        - plugin: "simple_bias"
          method: "stopCapture"

# ============================================================================
# INTERTRIAL - Execute between each trial
# Used for baseline periods and resetting hardware state
# ============================================================================
intertrial:
  include: true
  commands:
    # Reset to baseline pattern
    - type: "streamFrame"
      pattern: "./patterns/pat0006_uniform_gray.pat"
      duration: 2000  # 2 second inter-trial interval
      mode: 0
      frame_index: 1
      frame_rate: 60
      gain: 0
      offset: 0
    
    # Run analysis script on previous trial
    - plugin: "analysis"
    
    # Brief pause
    - type: "wait"
      duration: 500  # 0.5 second

# ============================================================================
# POSTTRIAL - Execute once after all trials complete
# Used for cleanup, data saving, and shutdown
# ============================================================================
posttrial:
  include: true
  commands:
    # Stop all recording systems
    - plugin: "simple_bias"
      method: "disconnect"
    
    - plugin: "daq_system"
      method: "disconnect"
    
    # Turn off hardware
    - plugin: "background_light"
      command: "off"
    
    - plugin: "led_controller"
      command: "off"
    
    # Display completion message pattern
    - type: "streamFrame"
      pattern: "./patterns/pat0007_complete.pat"
      duration: 2000
      mode: 0
      frame_index: 1
      frame_rate: 60
      gain: 0
      offset: 0
    
    # Final wait before shutdown
    - type: "wait"
      duration: 1000  # 1 second
