%% prepare_g41_experiment_sd.m — Stage G4.1 experiment patterns for SD card
%
% Collects the 12 patterns generated by create_g41_experiment_patterns.m,
% stages them in numbered order, and copies to SD card.
%
% Patterns on SD card (pat0001.pat through pat0012.pat):
%   1.  pat01_sq_grating_30deg_gs2        — 30° square, GS2, 16 frames
%   2.  pat02_sq_grating_30deg_gs16       — 30° square, GS16, 16 frames
%   3.  pat03_sq_grating_60deg_gs2        — 60° square, GS2, 32 frames
%   4.  pat04_sq_grating_60deg_gs16       — 60° square, GS16, 32 frames
%   5.  pat05_sine_grating_30deg_gs16     — 30° sine, GS16, 16 frames
%   6.  pat06_sine_grating_60deg_gs16     — 60° sine, GS16, 32 frames
%   7.  pat07_sine_grating_30deg_fine_gs16 — 30° sine fine, GS16, 64 frames
%   8.  pat08_sine_grating_60deg_fine_gs16 — 60° sine fine, GS16, 128 frames
%   9.  pat09_counter_0000_1000_gs2       — Counter, GS2, 1001 frames
%   10. pat10_counter_0000_1000_gs16      — Counter, GS16, 1001 frames
%   11. pat11_luminance_levels_gs2        — Luminance, GS2, 2 frames
%   12. pat12_luminance_levels_gs16       — Luminance, GS16, 16 frames
%
% Usage:
%   1. Run create_g41_experiment_patterns.m first
%   2. Insert SD card (named PATSD, FAT32) — drive D: on Windows
%   3. Run this script
%   4. Eject SD card safely

%% Setup
cd(project_root());
clear classes;
addpath(genpath('.'));

pat_dir = fullfile(pwd, 'patterns', 'reference', 'G41_2x12_cw');

%% Collect pattern files in order
pat_listing = dir(fullfile(pat_dir, '*_G4.pat'));
if isempty(pat_listing)
    error('No .pat files found in %s. Run create_g41_experiment_patterns.m first.', pat_dir);
end

% Sort by filename (pat01_, pat02_, etc.)
names = sort({pat_listing.name});
pat_paths = cellfun(@(f) fullfile(pat_dir, f), names, 'UniformOutput', false);

fprintf('=== G4.1 Experiment SD Card Preparation ===\n');
fprintf('Found %d patterns in %s\n\n', length(pat_paths), pat_dir);
for i = 1:length(pat_paths)
    [~, fn, ext] = fileparts(pat_paths{i});
    fprintf('  SD slot %2d: %s%s\n', i, fn, ext);
end

%% Platform-aware SD card deployment
if ispc
    % Windows: use drive letter
    sd_drive = 'D';
    fprintf('\nWindows detected. Using drive %s:\n', sd_drive);
    fprintf('Make sure SD card (PATSD) is inserted in drive %s:\n\n', sd_drive);

    reply = input('Proceed with SD card copy? (y/n): ', 's');
    if ~strcmpi(reply, 'y')
        fprintf('Aborted.\n');
        return;
    end

    mapping = prepare_sd_card(pat_paths, sd_drive, 'Format', true);
elseif ismac
    % macOS: stage to a local directory (copy manually to SD card)
    staging_dir = fullfile(pwd, 'tests', 'sd_staging');
    if ~exist(staging_dir, 'dir')
        mkdir(staging_dir);
    end

    fprintf('\nmacOS detected. Staging patterns to:\n  %s\n', staging_dir);
    fprintf('You will need to copy these to the SD card manually.\n\n');

    % Stage files with pat0001.pat naming
    for i = 1:length(pat_paths)
        sd_name = sprintf('pat%04d.pat', i);
        src = pat_paths{i};
        dst = fullfile(staging_dir, sd_name);
        copyfile(src, dst);
        fprintf('  %s -> %s\n', names{i}, sd_name);
    end

    % Write a simple manifest text file
    manifest_path = fullfile(staging_dir, 'MANIFEST.txt');
    fid = fopen(manifest_path, 'w');
    fprintf(fid, 'G4.1 Experiment Patterns — %s\n', datestr(now, 'yyyy-mm-dd HH:MM:SS'));
    fprintf(fid, 'Arena: G41_2x12_cw (32x192, 2x12 panels)\n');
    fprintf(fid, 'Pattern count: %d\n\n', length(pat_paths));
    for i = 1:length(pat_paths)
        fprintf(fid, 'pat%04d.pat <- %s\n', i, names{i});
    end
    fclose(fid);

    fprintf('\n  Wrote %s\n', manifest_path);
    fprintf('\nTo copy to SD card on Windows:\n');
    fprintf('  1. Format SD card as FAT32, label PATSD\n');
    fprintf('  2. Copy contents of %s to SD card root\n', staging_dir);
    fprintf('  3. Or copy the whole sd_staging folder content to E:\\patterns\\\n');

    mapping = struct('success', true, 'staging_dir', staging_dir, ...
                     'num_patterns', length(pat_paths));
else
    % Linux or other
    staging_dir = fullfile(pwd, 'tests', 'sd_staging');
    fprintf('Staging to %s (copy to SD card manually)\n', staging_dir);
    if ~exist(staging_dir, 'dir'), mkdir(staging_dir); end
    for i = 1:length(pat_paths)
        copyfile(pat_paths{i}, fullfile(staging_dir, sprintf('pat%04d.pat', i)));
    end
    mapping = struct('success', true, 'staging_dir', staging_dir, ...
                     'num_patterns', length(pat_paths));
end

fprintf('\n=== Done. %d patterns staged. ===\n', length(pat_paths));
